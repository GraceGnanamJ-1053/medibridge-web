name: CI - Build and Push Docker Image

# Run this workflow every time a push is made to the "main" branch
on:
  push:
    branches: [ "main" ] # [cite: 504, 505]

jobs:
  build-and-push:
    runs-on: ubuntu-latest # [cite: 511]
    steps:

      # 1. CHECKOUT STAGE: Get your code
      - name: Checkout
        uses: actions/checkout@v4 # [cite: 513, 514]

      # 2. TEST STAGE: Lint the HTML file
      - name: Lint HTML
        run: |
          echo "Installing linter..."
              # Use the official alpine image, install the linter (tidyhtml), and run it
              docker run --rm -v $(pwd):/data alpine:latest sh -c "apk add --no-cache tidyhtml && tidy -q -e /data/index.html"

      # 3. BUILD STAGE (Part 1): Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} # [cite: 539, 540]
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. BUILD STAGE (Part 2): Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3 # [cite: 536]

      # 5. DEPLOY STAGE (to Registry): Build and push the image
      - name: Build and push to Docker Hub
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true # [cite: 545]
          # This tags the image as "latest"
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/medibridge-web:latest